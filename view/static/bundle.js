(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{vD:()=>_e,LR:()=>be,xJ:()=>ye,Tq:()=>pe,Cv:()=>ge});class t extends EventTarget{constructor(e=null){super(),this.event_target=new EventTarget,this.events={},this.user_info={},this.rtc=new RTCPeerConnection;const t=this;this.rtc.onconnectionstatechange=function(e){if("disconnected"==e.target.connectionState)try{t.dispatchEvent(new CustomEvent("close-channel",{detail:{id:t.channel.label}}))}catch{}},this.ontrack_handler=this.ontrack_handler.bind(this),this.rtc.addEventListener("track",this.ontrack_handler),this.rtc.ontrack=this.ontrack_handler,this.tracks={},this.stream=void 0}addEventListener(e,t){this.events[e]=t,this.event_target.addEventListener(e,t)}dispatchEvent(e){this.event_target.dispatchEvent(e)}removeEventListener(e,t){delete this.events[e],this.event_target.removeEventListener(e,t)}addTrack(e){const t=this;e.getTracks().forEach((function(n){t.rtc.addTrack(n,e)}))}ontrack_handler(e){this.stream=e.streams[0],this.tracks[e.track.kind]=e.track}get_codecs(e){let t,n,i=e.indexOf("m=video"),s=e.indexOf("m=audio");i>s?(t=e.slice(s,i),n=e.slice(i)):(t=e.slice(s),n=e.slice(i,s));let o={},a={};n=n.split("\n"),t=t.split("\n");let l=n[0].replace("\r",""),r=t[0].replace("\r","");for(let e=0;e<n.length;e++)if(1==n[e].startsWith("a=rtpmap")){let t=n[e].split(" "),i=t[1].split("/")[0];o[t[0].split(":")[1]]=i}for(let e=0;e<t.length;e++)if(1==t[e].startsWith("a=rtpmap")){let n=t[e].split(" "),i=n[1].split("/")[0];a[n[0].split(":")[1]]=i}return{video:o,audio:a,video_settings:l,audio_settings:r}}choose_codec(e,t,n){let i=t.video_settings,s=t.audio_settings;if(null!=e.video)for(let n in t.video)if(t.video[n]==e.video){let e=i.split(" "),t=e.slice(0,3),s=e.slice(3),o=s.splice(s.indexOf(n),1);s=o.concat(s),i=t.concat(s).join(" ");break}if(null!=e.audio)for(let n in t.audio)if(t.audio[n]==e.audio){let e=t.audio_settings.split(" "),i=e.slice(0,3),o=e.slic3(3),a=o.splice(o.indexOf(n),1);o=a.concat(o),s=i.concat(o).join(" ");break}let o=n.replace(t.audio_settings,s);return o=o.replace(t.video_settings,i),o}async accept(e){let t,n,i=[],s=new Promise(((e,n)=>{t=e}));try{n=new RTCSessionDescription(e.sdp)}catch{return t(!1),s}try{if(0==Array.isArray(e["ice-candidates"]))return t(!1),s;for(let t=0;t<e["ice-candidates"].length;t++)i.push(new RTCIceCandidate(e["ice-candidates"][t]))}catch{return t(!1),s}this.rtc.setRemoteDescription(n);for(let e=0;e<i.length;e++)this.rtc.addIceCandidate(i[e]);return s}async createAnswer(e){this.rtc_connection_type="receiver";const t=this;let n,i=[];const s=new Promise(((e,t)=>{n=e}));let o;this.rtc.ondatachannel=function(e){t.channel=e.channel,t.channel.tasks=[];const n=t.channel.send.bind(t.channel);t.channel.onbufferedamountlow=function(){0!=t.channel.tasks.length&&(n(t.channel.tasks[0]),t.channel.tasks=t.channel.tasks.slice(1))},t.channel.send=function(e){0==t.channel.bufferedAmount?n(e):t.channel.tasks.push(e)},t.channel.onmessage=function(e){t.dispatchEvent(new CustomEvent("message",{detail:{data:e.data,id:t.channel.label}}))},t.channel.onopen=function(){t.dispatchEvent(new CustomEvent("open-channel",{detail:{id:e.channel.label}}))},t.channel.onclose=function(){t.dispatchEvent(new CustomEvent("close-channel",{detail:{id:e.channel.label}}))}},this.rtc.onicecandidate=function(e){e.candidate&&i.push(e.candidate.toJSON())},this.rtc.onicegatheringstatechange=function(){"complete"==t.rtc.iceGatheringState&&(i=i.filter((e=>-1==e.candidate.indexOf("tcp"))),n({sdp:t.rtc.localDescription.toJSON(),"ice-candidates":i}))};let a=[];try{o=new RTCSessionDescription(e.sdp)}catch{return n(!1),s}try{if(0==Array.isArray(e["ice-candidates"]))return n(!1),s;for(let t=0;t<e["ice-candidates"].length;t++)a.push(new RTCIceCandidate(e["ice-candidates"][t]))}catch{return n(!1),s}return this.rtc.setRemoteDescription(o),this.rtc.createAnswer().then((async function(e){await t.rtc.setLocalDescription(e);for(let e=0;e<a.length;e++)t.rtc.addIceCandidate(a[e])})).catch((function(){n(!1)})),s}createOffer(e){this.rtc_connection_type="creator";const t=this;let n,i=[];const s=new Promise(((e,t)=>{n=e}));this.rtc.onicecandidate=function(e){e.candidate&&i.push(e.candidate.toJSON())},this.rtc.onicegatheringstatechange=function(){"complete"==t.rtc.iceGatheringState&&(i=i.filter((e=>-1==e.candidate.indexOf("tcp"))),n({sdp:t.rtc.localDescription.toJSON(),"ice-candidates":i}))},this.channel=this.rtc.createDataChannel(e),this.channel.tasks=[];const o=this.channel.send.bind(this.channel);return this.channel.onbufferedamountlow=function(){0!=t.channel.tasks.length&&(o(t.channel.tasks[0]),t.channel.tasks=t.channel.tasks.slice(1))},this.channel.send=function(e){0==t.channel.bufferedAmount?o(e):t.channel.tasks.push(e)},this.channel.onmessage=function(e){t.dispatchEvent(new CustomEvent("message",{detail:{data:e.data,id:t.channel.label}}))},this.channel.onopen=function(){t.dispatchEvent(new CustomEvent("open-channel",{detail:{id:t.channel.label}}))},this.channel.onclose=function(){t.dispatchEvent(new Event("close-channel"))},this.rtc.createOffer().then((function(e){t.rtc.setLocalDescription(e)})),s}}let n;function i(e,t,n){let i;return i="vertex"==e?n.createShader(n.VERTEX_SHADER):n.createShader(n.FRAGMENT_SHADER),n.shaderSource(i,document.querySelector(t).innerText),n.compileShader(i),i}function s(e,t,n){let s=i("vertex",t,e),o=i("fragment",n,e),a=e.createProgram();return e.attachShader(a,s),e.attachShader(a,o),e.linkProgram(a),a}let o=mat4.create();class a{constructor(e){this.gl=e,this.program=s(this.gl,"#vertex-shader-lines","#fragment-shader-lines"),this.attrs={},this.uniforms={},this.vertices_buffer=this.gl.createBuffer(this.gl.ARRAY_BUFFER)}init(){this.gl.useProgram(this.program),this.attrs.aPosition=this.gl.getAttribLocation(this.program,"aPosition"),this.gl.enableVertexAttribArray(this.attrs.aPosition),this.uniforms.VMatrix=f.getUniformLocation(this.program,"VMatrix"),this.uniforms.PMatrix=f.getUniformLocation(this.program,"PMatrix"),f.uniformMatrix4fv(this.uniforms.PMatrix,!1,n)}draw(e,t){this.gl.useProgram(this.program),this.gl.uniformMatrix4fv(this.uniforms.VMatrix,!1,o),this.gl.uniformMatrix4fv(this.uniforms.PMatrix,!1,n),this.gl.bindBuffer(f.ARRAY_BUFFER,this.vertices_buffer),this.gl.bufferData(f.ARRAY_BUFFER,new Float32Array(e),f.STATIC_DRAW),this.gl.vertexAttribPointer(this.attrs.aPosition,3,f.FLOAT,!1,0,0),f.drawArrays(f.LINES,0,2*t)}}let l={x:0,y:0};class r{constructor(e){this.gl=e,this.program=s(this.gl,"#pick-vertex-shader","#pick-fragment-shader"),this.attrs={},this.uniforms={}}createFramebuffer(){let e=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e);let t=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,f.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,t,0),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),e}init(){this.gl.useProgram(this.program),this.fb=this.createFramebuffer(),this.attrs.aPosition=this.gl.getAttribLocation(this.program,"aPosition"),this.gl.enableVertexAttribArray(this.attrs.aPosition),this.uniforms.VMatrix=this.gl.getUniformLocation(this.program,"VMatrix"),this.uniforms.PMatrix=this.gl.getUniformLocation(this.program,"PMatrix"),this.gl.uniformMatrix4fv(this.uniforms.PMatrix,!1,n),this.uniforms.pick_color=this.gl.getUniformLocation(this.program,"pick_color"),this.uniforms.top_left_corner_coords=this.gl.getUniformLocation(this.program,"top_left_corner_coords"),this.uniforms.radius=this.gl.getUniformLocation(this.program,"radius"),this.gl.uniform1f(this.uniforms.radius,90),this.vertices_buffer=this.gl.createBuffer(this.gl.ARRAY_BUFFER),this.indices_buffer=this.gl.createBuffer(this.gl.ELEMENT_ARRAY_BUFFER),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indices_buffer),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,3,0]),this.gl.STATIC_DRAW),this.gl.useProgram(null)}draw(e){this.gl.useProgram(this.program),this.gl.uniformMatrix4fv(this.uniforms.VMatrix,!1,o),this.gl.uniformMatrix4fv(this.uniforms.PMatrix,!1,n);for(let t=0;t<e.length;t++){let n=[g.nodes[t].unique_id_color[0]/255,g.nodes[t].unique_id_color[1]/255,g.nodes[t].unique_id_color[2]/255];this.gl.uniform3fv(this.uniforms.pick_color,n),this.gl.uniform2fv(this.uniforms.top_left_corner_coords,[e[t][0],e[t][1]]),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertices_buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(e[t]),this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.attrs.aPosition,3,f.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indices_buffer),this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0)}this.gl.useProgram(null)}}class c{constructor(e){this.gl=e,this.program=s(this.gl,"#vertex-shader","#fragment-shader"),this.attrs={},this.uniforms={}}init(){this.gl.useProgram(this.program),this.attrs.aPosition=this.gl.getAttribLocation(this.program,"aPosition"),this.gl.enableVertexAttribArray(this.attrs.aPosition),this.attrs.uv_coords=this.gl.getAttribLocation(this.program,"a_texture_coords"),this.gl.enableVertexAttribArray(this.attrs.uv_coords),this.uv_buffer=this.gl.createBuffer(this.gl.ARRAY_BUFFER),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.uv_buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,1]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.uniforms.VMatrix=f.getUniformLocation(this.program,"VMatrix"),this.uniforms.PMatrix=f.getUniformLocation(this.program,"PMatrix"),this.gl.uniformMatrix4fv(this.uniforms.PMatrix,!1,n),this.uniforms.sampler=f.getUniformLocation(this.program,"uSampler"),f.uniform1i(this.uniforms.sampler,0),this.vertices_buffer=this.gl.createBuffer(this.gl.ARRAY_BUFFER),this.indices_buffer=this.gl.createBuffer(this.gl.ELEMENT_ARRAY_BUFFER),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indices_buffer),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,3,0]),this.gl.STATIC_DRAW),this.gl.useProgram(null)}draw(e){this.gl.useProgram(this.program),this.gl.uniformMatrix4fv(this.uniforms.VMatrix,!1,o),this.gl.uniformMatrix4fv(this.uniforms.PMatrix,!1,n);for(let t=0;t<e.length;t++)this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,g.nodes[t].texture),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertices_buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(e[t]),this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.attrs.aPosition,3,f.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.uv_buffer),this.gl.vertexAttribPointer(this.attrs.uv_coords,2,f.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indices_buffer),this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0);this.gl.useProgram(null)}}let d=-800;const u=document.querySelector("#canvas"),h=document.querySelector("#text-canvas");let f,p;function m(){let e=u.getBoundingClientRect(),t=window.devicePixelRatio||1;u.width=e.width*t,u.height=e.height*t,h.width=u.width,h.height=u.height,f=u.getContext("webgl",{alpha:!0}),p=h.getContext("2d"),f.viewport(0,0,u.width,u.height),f.enable(f.DEPTH_TEST),f.depthFunc(f.LEQUAL),f.clearDepth(1)}m(),window.addEventListener("resize",(function(){m()}));const g=new class{constructor(e){this.gl=e,this.nodes=[]}get_buffer(){let e=[],t=90;for(let n=0;n<this.nodes.length;n++){let i=[this.nodes[n].x-t,this.nodes[n].y-t,0,this.nodes[n].x+t,this.nodes[n].y-t,0,this.nodes[n].x+t,this.nodes[n].y+t,0,this.nodes[n].x-t,this.nodes[n].y+t,0];e.push(i)}return e}async add_node(e){let t=e.color,n=await async function(e,t=!1,n=[255,95,95,255]){let i,s=new Image;s.width=1024,s.height=1024,t&&(i=function(e){let t=document.createElement("canvas");t.width=1024,t.height=1024;let n=t.getContext("2d"),i=document.querySelector("#test-char"),s=window.getComputedStyle(i,null).getPropertyValue("font-size"),o=parseFloat(s),a=i.getBoundingClientRect(),l=a.width*"YOU".length/2,r=a.height;n.fillStyle="black",n.fillRect(0,0,1024,1024),n.font="{}px monospace".replace("{}",o/(d/-1280)),n.fillStyle="white";let c=512-1.5*l,u=1024-r/2;return n.fillText("YOU",c,u),n}());let o=new Promise(((e,o)=>{s.onload=function(){let o=document.createElement("canvas");o.width=1024,o.height=1024;let a=o.getContext("2d");a.drawImage(s,0,0,s.width,s.height);let l=a.getImageData(0,0,o.width,o.height);l=l.data;let r=o.width/2,c=o.height/2;for(let e=0;e<o.height;e++){let t=e*(4*o.width);for(let i=0;i<4*o.width;i+=4){let s=e,a=i/4,d=t+i,u=l.slice(d,d+4);37==u[0]&&180==u[1]&&90==u[2]&&(l[d]=0,l[d+1]=0,l[d+2]=0,l[d+3]=0,Math.sqrt((s-r)**2+(a-c)**2)<o.width/2?(l[d]=n[0],l[d+1]=n[1],l[d+2]=n[2],l[d+3]=n[3]):(l[d]=0,l[d+1]=0,l[d+2]=0,l[d+3]=0))}}if(t){let e=i.getImageData(0,0,1024,1024);e=e.data;for(let t=0;t<o.height;t++){let n=t*(4*o.width);for(let t=0;t<4*o.width;t+=4){let i=n+t,s=e.slice(i,i+4);255==s[0]&&255==s[1]&&255==s[2]&&(l[i]=255,l[i+1]=255,l[i+2]=255,l[i+3]=255)}}}a.clearRect(0,0,o.width,o.height);let d=new ImageData(l,o.width,o.height);a.putImageData(d,0,0);let u=new Image;u.onload=function(){e(u)},u.src=o.toDataURL()}}));return s.src=e,o}("/static/img/users/"+e.image,"self"==e.conn_id,t),i=function(e,t){e.RGBA,e.RGBA,e.UNSIGNED_BYTE;let n=e.createTexture();return e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.bindTexture(e.TEXTURE_2D,null),n}(this.gl,n);e.ready_img=n,e.texture=i,e.back_color=t,this.nodes.push(e)}}(f);function _(e,t,n){let i=t.x-e.x,s=t.y-e.y,o=Math.sqrt(i**2+s**2);i/=o,s/=o,null==e.last_x&&(e.last_x=e.x,e.last_y=e.y);let a=(e.x-e.last_x)/1.5,l=(e.y-e.last_y)/1.5,r=e.x+a+i*n,c=e.y+l+s*n;e.last_x=e.x,e.last_y=e.y,e.x=r,e.y=c}function b(e,t){let n=t.x-e.x,i=t.y-e.y,s=Math.sqrt(n**2+i**2);n/=s,i/=s,n*=.01*s,i*=.01*s,e.last_x=e.x,e.last_y=e.y,"number"==typeof n&&"number"==typeof i&&(e.x+=n,e.y+=i)}let y,w=0,v=!1,E=!1,x=!1;function A(e,t){let n=e.x-t.x,i=e.y-t.y,s=Math.sqrt(n**2+i**2);if(s>=280)return;let o=(280-s)/s,a=.2*n*o,l=.2*i*o;e.x+=a,e.y+=l}function T(e){let t=(e=e||window.event).deltaY||e.detail||e.wheelDelta;d-t>-700?d=-700:d-t<-4e3&&(d=-4e3),d-=t}setTimeout((function e(){w=null==y?Math.floor(Math.random()*g.nodes.length):y,setTimeout(e,1e3+5e3*Math.random())}),0),h.addEventListener?"onwheel"in document?h.addEventListener("wheel",T):"onmousewheel"in document?h.addEventListener("mousewheel",T):h.addEventListener("MozMousePixelScroll",T):h.attachEvent("onmousewheel",T);let k=["alien.png","bull.png","cat.png","cat1.png","cat2.png","deer.png","deer1.png","Devil.png","Devil1.png","frog.png","frog1.png","Ghost.png","Ghost1.png","pig.png","pumpkin.png","skull.png","skull1.png"],R=[];function S(){let e=Math.floor(65535*Math.random()),t=new Uint8Array(3);t[0]=255&e,t[1]=(65280&e)>>8;for(let t=0;t<R.length;t++)if(e==new DataView(R[t].buffer).getUint16(0,!0))return S();return R.push(t),t}function M(e){let t=window.devicePixelRatio||1,n=e.offsetX*t,i=e.offsetY*t;if(l.x=n,l.y=i,l.offsetX=e.offsetX,l.offsetY=e.offsetY,!1===v)return void(h.style.cursor="default");if("self"==g.nodes[v].conn_id?h.style.cursor="help":h.style.cursor="pointer",0==x)return;y=v;let s=u.height/t,o=u.width/t,a=(e.offsetX-o/2)*(d/-1200),r=(s/2-e.offsetY)*(d/-1200);g.nodes[v].x=a,g.nodes[v].y=r}h.addEventListener("contextmenu",(function(e){e.preventDefault()}));let L=!1,B=function(e){};function F(e,t="mouse"){if("mouse"==t){let t;if("which"in(e=e||window.event)?t=3==e.which:"button"in e&&(t=2==e.button),!t)return void(x=!1)}if(x=!0,!1===v)return;y=v,w=v;let n=window.devicePixelRatio||1,i=u.height/n,s=u.width/n;"touch"!=t&&function e(){let t=(l.offsetX-s/2)*(d/-1200),n=(i/2-l.offsetY)*(d/-1200);g.nodes[v].x=t,g.nodes[v].y=n;for(let e=0;e<g.nodes.length;e++){if(v==e)continue;let t=e;b(g.nodes[t],g.nodes[v])}E||requestAnimationFrame(e)}()}h.onmousemove=function(e){M(e)},h.ontouchmove=function(e){L?B(e):(e.offsetX=e.touches[0].pageX,e.offsetY=e.touches[0].pageY,M(e))};let U,z=!0;function P(){if(!1!==v)if("self"==g.nodes[v].conn_id){let e=document.querySelector(".upload-block-info");e.style.zIndex=999,e.style.opacity=1}else{let e=Array.from(document.querySelectorAll("files-elem")).find((e=>e.getAttribute("conn-id")==g.nodes[v].conn_id));e&&(e.setAttribute("style","opacity: 1; z-index: 1;"),document.querySelector(".users-files").setAttribute("style","opacity: 1; z-index: 9999;"))}}h.ontouchstart=function(e){if(z=!1,2==e.touches.length)return L=!0,void(B=function(e){let t=Math.hypot(e.touches[0].pageX-e.touches[1].pageY,e.touches[0].pageY-e.touches[1].pageY);return function(e){const n=Math.hypot(e.touches[0].pageX-e.touches[1].pageY,e.touches[0].pageY-e.touches[1].pageY);let i=4*(n-t);t=n,d+i>-700?d=-700:d+i<-4e3?d=-4e3:d+=i}}(e));e.offsetX=e.touches[0].pageX,e.offsetY=e.touches[0].pageY;let t=window.devicePixelRatio||1,n=e.offsetX*t,i=e.offsetY*t;l.x=n,l.y=i,l.offsetX=e.offsetX,l.offsetY=e.offsetY,F(e,"touch")},h.onmousedown=function(e){"ontouchstart"in window||F(e,"mouse")},h.onmouseup=function(e){if("ontouchstart"in window)return;let t;"which"in(e=e||window.event)?t=3==e.which:"button"in e&&(t=2==e.button),t||P(),x=!1,E=!0,v=!1,y=void 0},h.onmouseout=function(){"ontouchstart"in window||(x=!1,E=!0,v=!1,y=void 0)},h.ontouchcancel=function(e){x=!1,E=!0,v=!1,y=void 0},h.ontouchend=function(e){L&&(L=!1),function(){if(null!=U){var e=(new Date).getTime()-U;e<600&&e>0&&P(),U=(new Date).getTime()}else U=(new Date).getTime()}(),x=!1,E=!0,v=!1,y=void 0};let D,q,C,O,N,j=function(e,t,i,s){n=mat4.perspective(40,u.width/u.height,.001,1e4);let h=new a(t);h.init();let f=new r(t);f.init();let p=new c(t);return p.init(),t.viewport(0,0,u.width,u.height),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.clearDepth(1),window.devicePixelRatio,function(){n=mat4.perspective(40,u.width/u.height,.001,1e4),mat4.identity(o),mat4.translate(o,[0,0,d]),t.clearColor(1,1,1,0),t.clear(t.COLOR_BUFFER_BIT||t.DEPTH_BUFFER_BIT),e.clearRect(0,0,u.width,u.height);let a=i.get_buffer(),r=[],c=0;for(let e=0;e<i.nodes.length;e++)for(let t=0;t<i.nodes.length;t++){if(e==t)continue;let n=t;try{let t=[i.nodes[e].x,i.nodes[e].y,0,i.nodes[n].x,i.nodes[n].y,0];c+=1,r.push(...t)}catch{continue}}h.draw(r,c),f.draw(a);var m=new Uint8Array(4);t.readPixels(l.x,u.height-l.y,1,1,t.RGBA,t.UNSIGNED_BYTE,m),s(m),p.draw(a)}}(p,f,g,(function(e){if("ontouchstart"in window){let t=new DataView(e.buffer);for(let e=0;e<g.nodes.length;e++)if(new DataView(g.nodes[e].unique_id_color.buffer).getUint16(0,!0)==t.getUint16(0,!0))return v=e,w=e,E=!1,void u.addEventListener("touchend",(function e(){E=!0,u.removeEventListener("touchend",e)}))}else{if(x)return;let t=new DataView(e.buffer);for(let e=0;e<g.nodes.length;e++)if(new DataView(g.nodes[e].unique_id_color.buffer).getUint16(0,!0)==t.getUint16(0,!0))return void(v=e);v=!1}})),Y=[];D=1e3/60,O=Date.now(),q=O,async function e(){if(requestAnimationFrame(e),C=Date.now(),N=C-O,N>D){if(O=C-N%D,0!=Y.length){let e=Y.splice(0,1);await e[0]()}try{j(),function(){if(g.nodes.length<1)return;let e={x:0,y:0};if(null==y)try{b(g.nodes[w],e)}catch{}for(let e=0;e<g.nodes.length;e++){if(e==w)continue;let t=e;_(g.nodes[t],g.nodes[w],.5),A(g.nodes[t],g.nodes[w]);for(let e=0;e<g.nodes.length;e++){let n=e;n!=w&&n!=t&&A(g.nodes[n],g.nodes[t])}}}(),function(){if(!(g.nodes.length<1))for(let e=0;e<g.nodes.length;e++)w!=e&&b(g.nodes[e],g.nodes[w])}()}catch{}}}();let I={};const X=["rar","7z","arj","bz2","cab","gz","jar","lz","lzh","tar","uue","xz","z","zipx","001"];class H extends HTMLElement{constructor(){super(),this.uploaded=0}async load_img(e){let t=e.split(".");return t=t[t.length-1],new Promise(((e,n)=>{let i=new Image;i.onload=function(){e("/static/img/file_types/{}.png".replace("{}",t))},i.onerror=function(){-1!=X.indexOf(t)?e("/static/img/file_types/archive.png"):e("/static/img/file_types/nfo.png")},i.src="/static/img/file_types/{}.png".replace("{}",t)}))}formatBytes(e,t=2){if(0===e)return"0 Bytes";const n=t<0?0:t,i=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,i)).toFixed(n))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][i]}cancel(){this.setAttribute("uploaded",100),this.change_upload_info_func(100),this.pause_block.style.opacity=0,this.cancel_block.style.opacity=1,this.success_block.style.opacity=0,this.uploaded_div.style.opacity=0}pause(){this.pause_block.style.opacity=1,this.uploaded_div.style.opacity=0}resume(){this.pause_block.style.opacity=0,this.cancel_block.style.opacity=0,this.success_block.style.opacity=0,this.uploaded_div.style.opacity=1}async connectedCallback(){await this.init(),this.append(this.html)}async init(){let e=document.createElement("div");e.setAttribute("class","upload-file-obj");let t=document.createElement("img");t.src=await this.load_img(this.file_name);let n=document.createElement("span");n.innerText=ye(this.file_name);let i=document.createElement("span");i.innerText=this.formatBytes(ge[this.file_name].size),this.full_size=ge[this.file_name].size,this.uploaded_div=document.createElement("div"),this.uploaded_div.setAttribute("class","progress-background"),this.uploaded_div.style.width="0%",this.uploaded_num=document.createElement("div"),this.uploaded_num.setAttribute("class","gray-background"),this.uploaded_num.innerText="0%",this.pause_block=document.createElement("div"),this.pause_block.setAttribute("class","pause"),this.pause_block.innerHTML='<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="pause" class="svg-inline--fa fa-pause fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M144 479H48c-26.5 0-48-21.5-48-48V79c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v352c0 26.5-21.5 48-48 48zm304-48V79c0-26.5-21.5-48-48-48h-96c-26.5 0-48 21.5-48 48v352c0 26.5 21.5 48 48 48h96c26.5 0 48-21.5 48-48z"></path></svg>',this.cancel_block=document.createElement("div"),this.cancel_block.setAttribute("class","cancel"),this.cancel_block.innerHTML='<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="ban" class="svg-inline--fa fa-ban fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119.034 8 8 119.033 8 256s111.034 248 248 248 248-111.034 248-248S392.967 8 256 8zm130.108 117.892c65.448 65.448 70 165.481 20.677 235.637L150.47 105.216c70.204-49.356 170.226-44.735 235.638 20.676zM125.892 386.108c-65.448-65.448-70-165.481-20.677-235.637L361.53 406.784c-70.203 49.356-170.226 44.736-235.638-20.676z"></path></svg>',this.success_block=document.createElement("div"),this.success_block.setAttribute("class","success"),this.success_block.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" data-prefix="far" data-icon="check-circle" class="svg-inline--fa fa-check-circle fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 48c110.532 0 200 89.451 200 200 0 110.532-89.451 200-200 200-110.532 0-200-89.451-200-200 0-110.532 89.451-200 200-200m140.204 130.267l-22.536-22.718c-4.667-4.705-12.265-4.736-16.97-.068L215.346 303.697l-59.792-60.277c-4.667-4.705-12.265-4.736-16.97-.069l-22.719 22.536c-4.705 4.667-4.736 12.265-.068 16.971l90.781 91.516c4.667 4.705 12.265 4.736 16.97.068l172.589-171.204c4.704-4.668 4.734-12.266.067-16.971z"/></svg>',e.append(t),e.append(n),e.append(i),e.append(this.uploaded_div),e.append(this.uploaded_num),e.append(this.pause_block),e.append(this.cancel_block),e.append(this.success_block),this.html=e,I[this.conn_id].addDownloadObj(this)}listen(e){this.change_upload_info_func=e}static get observedAttributes(){return["conn-id","file-name","uploaded"]}attributeChangedCallback(e,t,n){if("conn-id"==e){if(this.conn_id=n,!I[this.conn_id]){let e=document.createElement("uploadinfouser-elem");e.setAttribute("conn-id",this.conn_id),I[this.conn_id]=e,document.querySelector("#upload-info").style.opacity=0,document.querySelector("#back-upload-block-btn").style.opacity=1,document.querySelector(".upload-block-info .users").style.opacity=1,document.querySelector(".upload-block-info .users").append(e)}I[this.conn_id].container.append(this)}else"file-name"==e&&(this.file_name=n);"uploaded"==e&&(100==n&&(this.success_block.style.opacity=1,this.uploaded_div.style.opacity=0),this.uploaded=n,this.change_upload_info_func(n),this.uploaded_div.style.width=String(n)+"%",this.uploaded_num.innerText=String(n)+"%")}}class G extends HTMLElement{constructor(){super(),this.download_objs=[],this.full_size=0}connectedCallback(){this.append(this.html)}init(){const e=this;let t=document.createElement("div");t.setAttribute("class","user-obj");let n=document.querySelector(".upload-block-info .users");t.onclick=function(){window.innerWidth<=560&&n.setAttribute("style","transform: translateX(-100%); opacity: 1;");let t=document.querySelectorAll(".upload-files .files-info-container");for(let e=0;e<t.length;e++)t[e].style.display="none";e.container.style.display="grid"},this.uploaded_div=document.createElement("div"),this.uploaded_div.setAttribute("class","uploaded"),this.uploaded_div.style.width="0%",this.uploaded_num=document.createElement("span"),this.uploaded_num.setAttribute("class","uploaded-num"),this.uploaded_num.innerText="0%",t.append(this.node_obj.ready_img),t.append(this.uploaded_div),t.append(this.uploaded_num),this.container=document.createElement("div"),this.container.setAttribute("class","files-info-container"),document.querySelector(".upload-block-info .upload-files").append(this.container),this.html=t}addDownloadObj(e){const t=this;e.listen((function(e){let n=0;for(let e=0;e<t.download_objs.length;e++)n+=Number(t.download_objs[e].uploaded)/100*ge[t.download_objs[e].file_name].size;n=Math.round(n/t.full_size*100),t.uploaded_div.style.width=String(n)+"%",t.uploaded_num.innerText=String(n)+"%"})),this.full_size+=ge[e.file_name].size,this.download_objs.push(e)}static get observedAttributes(){return["conn-id"]}attributeChangedCallback(e,t,n){if("conn-id"==e){let e=g.nodes.find((e=>e.conn_id==n));if(!e)return;this.node_obj=e,this.init()}}}customElements.define("uploadinfouser-elem",G),customElements.define("uploadinfoblock-elem",H);let V=new class{constructor(){this.queue={};const e=this;let t=indexedDB.open("lockStore");t.onupgradeneeded=function(){e.db=t.result,e.db.objectStoreNames.contains("testStore")||e.db.createObjectStore("testStore",{keyPath:"id"})},t.onsuccess=function(){e.db=t.result}}async resolve_main_pause(e,t){await this.block_operation();let n={key:null,obj:null};for(let i in this.queue[e]){let s=this.queue[e][i];if(s.id==t&&1==s.main_pause){n.key=i,n.obj=s;break}}if(!n.key)return;let i=0;for(let t in this.queue[e]){let s=this.queue[e][t];if(0==s.main_pause&&null==s.subscriber){this.queue[e][t].subscriber=n.key,this.queue[e][n.key].subscribition=t,this.queue[e][n.key].main_pause=!1,i=1;break}}0==i&&(this.queue[e][n.key].main_pause=!1,this.queue[e][n.key].ready=!1,this.queue[e][n.key].resolve())}async resolve(e,t){await this.block_operation();let n={key:null,obj:null};for(let i in this.queue[e]){let s=this.queue[e][i];if(s.id==t&&0==s.ready){n.key=i,n.obj=s;break}}n.obj&&(this.queue[e][n.obj.subscriber]&&(this.queue[e][n.obj.subscriber].ready=!1,this.queue[e][n.obj.subscriber].resolve()),delete this.queue[e][n.key])}async block_operation(){const e=this;return new Promise(((t,n)=>{let i=e.db.transaction("testStore","readwrite"),s=i.objectStore("testStore");s.add({id:"test"}),s.delete("test"),i.oncomplete=function(){t(!0)}}))}async register(e,t,n,i){let s="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));await this.block_operation();let o={id:t,resolve:n,main_pause:i,ready:!0,subscriber:null};if(this.queue[e]){let t=0;for(let n in this.queue[e])if(0==this.queue[e][n].main_pause){t+=1;break}if(0==t)i||(o.ready=!1,n(!0)),this.queue[e][s]=o;else{if(this.queue[e][s]=o,i)return;for(let t in this.queue[e]){let n=this.queue[e][t];if(null==n.subscriber&&0==n.main_pause){this.queue[e][t].subscriber=s;break}}}}else this.queue[e]={},i||(o.ready=!1,n(!0)),this.queue[e][s]=o}};class J{constructor(e,t){this.id=t,this.event_target=e,this.pause=!1,this.main_pause=!1;const n=this;this.event_target.addEventListener(this.id,(function(e){const t=e.detail;"pause"==t.type?n.pause=!0:"main-pause"==t.type?(n.info_block.pause(),n.main_pause=!0,n.pause=!0):"resume"==t.type?V.resolve(n.channel_id,n.id):"main-resume"==t.type?(n.info_block.resume(),V.resolve_main_pause(n.channel_id,n.id),n.main_pause=!1):"cancel"==t.type&&(n.cancel_operation=!0,n.main_pause&&(n.main_pause=!1,V.resolve_main_pause(n.channel_id,n.id)),n.cancel())}))}async resume_promise(){const e=this;return new Promise(((t,n)=>{V.register(e.channel_id,e.id,t,e.main_pause)}))}cancel_hook(e){this.cancel=e}}let W={};window.onbeforeunload=function(e){let t=0,n=0;for(let e in W)t+=W[e],n+=1;if(0!=n&&(t/=n,100!=t)){document.querySelector(".upload-block-info").setAttribute("style","opacity: 1; z-index: 999;"),e.preventDefault();let t="";return e.returnValue=t,t}};let K={},Z=document.querySelector("#open-download");Z=Z.querySelector("svg"),K=new Proxy(K,{set:function(e,t,n){e[t]=n;let i=0,s=0;for(let t in e)i+=e[t],s+=1;return 0==s?i=0:i/=s,100==i?Z.setAttribute("class","download-btn"):Z.setAttribute("class","download-btn-anim"),!0}}),window.onbeforeunload=function(e){let t=0,n=0;for(let e in K)t+=K[e],n+=1;if(0!=n&&(t/=n,100!=t)){document.querySelector("#open-download").click(),e.preventDefault();let t="";return e.returnValue=t,t}};class Q extends HTMLElement{constructor(){super(),this.load_data={operation_id:null,connection_id:null}}choose_state(e){"pause"==e?(this.pause_button.setAttribute("style","display: none;"),this.resume_button.setAttribute("style","display: block;")):"resume"==e&&(this.pause_button.setAttribute("style","display: block;"),this.resume_button.setAttribute("style","display: none;"))}init(e,t,n,i){const s=this,o=this.load_data.operation_id,a=this.load_data.connection_id;let l=document.createElement("div");l.setAttribute("class","file-download-obj");let r=document.createElement("div");r.setAttribute("class","file-obj");let c=document.createElement("img");c.src=e;let d='\n      <span style="margin-bottom: 5px;" title="{full_file_name}">{filename}</span>\n      <span>{size}</span>',u=ye(t);d=d.replace("{full_file_name}",t),d=d.replace("{filename}",u),d=d.replace("{size}",n);let h=document.createElement("div");h.setAttribute("class","file-description"),h.innerHTML=d,r.append(c),r.append(h),this.pause_button=document.createElement("button"),this.pause_button.onclick=function(){s.choose_state("pause"),i(o,pe[a],"main-pause")},this.pause_button.setAttribute("class","pause"),this.pause_button.innerHTML='<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="pause" class="svg-inline--fa fa-pause fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M144 479H48c-26.5 0-48-21.5-48-48V79c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v352c0 26.5-21.5 48-48 48zm304-48V79c0-26.5-21.5-48-48-48h-96c-26.5 0-48 21.5-48 48v352c0 26.5 21.5 48 48 48h96c26.5 0 48-21.5 48-48z"></path></svg>',this.cencell_button=document.createElement("button"),this.cencell_button.onclick=function(){s.choose_state("cancel"),i(o,pe[a],"cancel")},this.cencell_button.setAttribute("class","cencell"),this.cencell_button.innerHTML='<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="ban" class="svg-inline--fa fa-ban fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119.034 8 8 119.033 8 256s111.034 248 248 248 248-111.034 248-248S392.967 8 256 8zm130.108 117.892c65.448 65.448 70 165.481 20.677 235.637L150.47 105.216c70.204-49.356 170.226-44.735 235.638 20.676zM125.892 386.108c-65.448-65.448-70-165.481-20.677-235.637L361.53 406.784c-70.203 49.356-170.226 44.736-235.638-20.676z"></path></svg>',this.resume_button=document.createElement("button"),this.resume_button.onclick=function(){s.choose_state("resume"),i(o,pe[a],"main-resume")},this.resume_button.setAttribute("class","resume"),this.resume_button.innerHTML='<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="play" class="svg-inline--fa fa-play fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M424.4 214.7L72.4 6.6C43.8-10.3 0 6.1 0 47.9V464c0 37.5 40.7 60.1 72.4 41.3l352-208c31.4-18.5 31.5-64.1 0-82.6z"></path></svg>',this.pause_button.setAttribute("style","display: block;"),this.cencell_button.setAttribute("style","display: block;"),this.resume_button.setAttribute("style","display: none;"),r.append(this.pause_button),r.append(this.resume_button),r.append(this.cencell_button);let f=document.createElement("div");f.setAttribute("class","progress-block"),f.innerHTML='<span class="progress"></span><span class="progress-num" style="position: absolute; right: 20px; line-height: 10px;">0%</span>',l.append(r),l.append(f),this.close_download_btn=document.createElement("button"),this.close_download_btn.onclick=function(){l.style.opacity=0,setTimeout((function(){s.remove(),0==document.querySelectorAll("download-elem").length&&(document.querySelector("#download-info").style.opacity=1)}),300)},this.close_download_btn.innerHTML='<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="times" class="svg-inline--fa fa-times fa-w-11" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path fill="currentColor" d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"></path></svg>',this.close_download_btn.setAttribute("class","close-download-btn"),this.close_download_btn.setAttribute("style","display: none;"),l.append(this.close_download_btn),this.html=l,K[o]=0}drop_buttons(){this.pause_button.setAttribute("style","display: none;"),this.cencell_button.setAttribute("style","display: none;"),this.resume_button.setAttribute("style","display: none;")}finish(){K[this.load_data.operation_id]=100,this.close_download_btn.setAttribute("style","display: block;"),"100%"!=this.querySelector(".progress-num").innerText?this.error():this.success()}success(){this.drop_buttons()}error(){this.drop_buttons()}connectedCallback(){this.append(this.html)}static get observedAttributes(){return["operation_id","connection_id","downloaded"]}attributeChangedCallback(e,t,n){-1!=["operation_id","connection_id"].indexOf(e)?this.load_data[e]=n:"downloaded"==e&&(K[this.load_data.operation_id]=Number(n),this.querySelector(".progress-num").innerText=String(n)+"%",this.querySelector(".progress").style.width=String(.75*n)+"%")}}customElements.define("download-elem",Q);class $ extends HTMLElement{constructor(){super(),this.state={files:[]},this.addFiles=function(e){this.state.files=e,this.render()}}connectedCallback(){const e=this;this.container=document.createElement("div"),this.container.setAttribute("class","files"),this.empty_space=document.createElement("div");let t=document.createElement("img");t.src="/static/img/users/nothing_here.jpg",this.empty_space.setAttribute("class","empty-space"),this.empty_space.append(t);let n=document.createElement("span");n.innerText=window.langObj.node_offers,this.empty_space.append(n),this.container.append(this.empty_space),this.append(this.container);let i=document.createElement("button");i.setAttribute("class","files-close-btn"),i.innerHTML='<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="times" class="svg-inline--fa fa-times fa-w-11" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path fill="currentColor" d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"></path></svg>',i.onclick=function(){e.setAttribute("style","z-index: -1; opacity: 0;"),document.querySelector(".users-files").setAttribute("style","z-index: -1;opacity: 0;")},this.append(i)}render(){let e=this.container.querySelectorAll("file-elem");const t=e.length;for(let n=0;n<t;n++)e[n].remove();if(0==this.state.files.length)this.empty_space.style.opacity=1;else{this.empty_space.style.opacity=0;for(let e=0;e<this.state.files.length;e++)this.container.append(this.state.files[e])}}}const ee=["rar","7z","arj","bz2","cab","gz","jar","lz","lzh","tar","uue","xz","z","zipx","001"];class te extends HTMLElement{constructor(){super(),this.state={download:null},this.file_name=null,this.conn_id=null}async load_img(){let e=this.file_name.split(".");return e=e[e.length-1],new Promise(((t,n)=>{let i=new Image;i.onload=function(){t("/static/img/file_types/{}.png".replace("{}",e))},i.onerror=function(){-1!=ee.indexOf(e)?t("/static/img/file_types/archive.png"):t("/static/img/file_types/nfo.png")},i.src="/static/img/file_types/{}.png".replace("{}",e)}))}formatBytes(e,t=2){if(0===e)return"0 Bytes";const n=t<0?0:t,i=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,i)).toFixed(n))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][i]}async init(){const e=this;this.download_button=document.createElement("button"),this.download_button.setAttribute("title",this.file_name),this.download_button.innerHTML='<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-down" class="svg-inline--fa fa-arrow-down fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M413.1 222.5l22.2 22.2c9.4 9.4 9.4 24.6 0 33.9L241 473c-9.4 9.4-24.6 9.4-33.9 0L12.7 278.6c-9.4-9.4-9.4-24.6 0-33.9l22.2-22.2c9.5-9.5 25-9.3 34.3.4L184 343.4V56c0-13.3 10.7-24 24-24h32c13.3 0 24 10.7 24 24v287.4l114.8-120.5c9.3-9.8 24.8-10 34.3-.4z"></path></svg>',this.download_button.onclick=function(){e.id="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));let t=document.createElement("download-elem");t.setAttribute("operation_id",e.id),t.setAttribute("connection_id",e.conn_id),t.init(n,e.file_name,e.formatBytes(e.size),_e),document.querySelector("#download-info").style.opacity=0,document.querySelector(".download-info-block").append(t),be(e.file_name,pe[e.conn_id],e.id,(function(){t.setAttribute("style","opacity: 0;"),setTimeout((function(){t.finish()}),300)}))},this.container=document.createElement("div"),this.container.setAttribute("class","file-container");let t='\n        <div class="file-bio">\n          <img src="{file_type_img}" alt="" />\n          <span title="{file_name_title}">{file_name}</span>\n          <span>{file_size}</span>\n        </div>\n    ',n=await this.load_img(),i=ye(this.file_name);t=t.replace("{file_name}",i),t=t.replace("{file_name_title}",this.file_name),t=t.replace("{file_type_img}",n),t=t.replace("{file_size}",this.formatBytes(this.size)),this.container.innerHTML=t,this.container.append(this.download_button)}connectedCallback(){this.append(this.container)}static get observedAttributes(){return["file-name","conn-id","size"]}attributeChangedCallback(e,t,n){"file-name"==e?this.file_name=n:"conn-id"==e?this.conn_id=n:"size"==e&&(this.size=Number(n)),null!=this.conn_id&&null!=this.file_name&&null!=this.size&&this.init()}}let ne=document.querySelector("#canvas");function ie(e){Y.push((function(){let t=-1;for(let n=0;n<g.nodes.length;n++)g.nodes[n].conn_id==e&&(t=n);-1!=t&&g.nodes.splice(t,1)}))}async function se(e,t,n){Y.push((async function(){return g.nodes.length,new Promise((async function(i,s){await g.add_node({x:(.5*Math.random()-.25)*(ne.width/2),y:(.5*Math.random()-.25)*(ne.height/2),image:n,conn_id:e,color:t,unique_id_color:S()}).then((function(){i(!0)}))}))}))}customElements.define("files-elem",$),customElements.define("file-elem",te);class oe extends HTMLElement{constructor(){super()}connectedCallback(){this.addFiles=function(e){let t=[];for(let n in e){let i=document.createElement("file-elem");i.setAttribute("file-name",n),i.setAttribute("conn-id",this.conn_id),i.setAttribute("size",e[n].size),t.push(i)}this.files.addFiles(t)},this.files=document.createElement("files-elem"),this.files.setAttribute("conn-id",this.conn_id),this.files.setAttribute("style","display: none;"),document.querySelector(".users-files").append(this.files)}static get observedAttributes(){return["conn-id"]}attributeChangedCallback(e,t,n){"conn-id"==e&&(this.conn_id=n)}disconnectedCallback(){this.files.remove()}}function ae(e){let t={а:"a",б:"b",в:"v",г:"g",д:"d",е:"e",ё:"e",ж:"j",з:"z",и:"i",к:"k",л:"l",м:"m",н:"n",о:"o",п:"p",р:"r",с:"s",т:"t",у:"u",ф:"f",х:"h",ц:"c",ч:"ch",ш:"sh",щ:"shch",ы:"y",э:"e",ю:"u",я:"ya"},n=[];e=e.replace(/[ъь]+/g,"").replace(/й/g,"i");for(let i=0;i<e.length;++i)n.push(t[e[i]]||null==t[e[i].toLowerCase()]&&e[i]||t[e[i].toLowerCase()].toUpperCase());return n=n.join(""),n=n.replaceAll(" ","_"),n}function le(){for(let e in pe)pe[e].channel.send(JSON.stringify({type:"message",body:{type:"files-data",files:ge}}))}const re=["rar","7z","arj","bz2","cab","gz","jar","lz","lzh","tar","uue","xz","z","zipx","001"];class ce extends HTMLElement{constructor(){super(),this.name=null,this.type=null,this.size=null}formatBytes(e,t=2){if(0===e)return"0 Bytes";const n=t<0?0:t,i=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,i)).toFixed(n))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][i]}async init(){const e=this;let t=this.name.split(".");t=t[t.length-1];let n=new Promise(((e,n)=>{let i=new Image;i.onload=function(){e("/static/img/file_types/{}.png".replace("{}",t))},i.onerror=function(){-1!=re.indexOf(t)?e("/static/img/file_types/archive.png"):e("/static/img/file_types/nfo.png")},i.src="/static/img/file_types/{}.png".replace("{}",t)}));t=await n;let i=document.createElement("div");i.setAttribute("class","file");let s=document.createElement("img");s.setAttribute("src",t);let o=ye(this.name),a=document.createElement("span");a.innerText=o,a.title=this.name;let l=document.createElement("span");l.innerText=this.formatBytes(this.size),i.append(s),i.append(a),i.append(l);let r=document.createElement("button");r.innerText="Delete",r.setAttribute("title",this.name),r.setAttribute("class","delete-btn"),r.onclick=function(){delete ge[e.name],le(),e.remove_file()},i.append(r),this.block=i,this.append(this.block)}static get observedAttributes(){return["name","size","type"]}async attributeChangedCallback(e,t,n){"name"==e?this.name=n:"size"==e?this.size=n:"type"==e&&(this.type=n),null!=this.name&&null!=this.size&&null!=this.type&&this.init()}}customElements.define("input-file",ce);class de extends HTMLElement{constructor(){super(),this.file_upload_elem=document.createElement("input"),this.file_upload_elem.setAttribute("type","file"),this.file_upload_elem.setAttribute("multiple",!0),this.input_files=[];const e=this;this.file_upload_elem.addEventListener("change",(function(){for(let e in ge)delete ge[e];let t=e.file_upload_elem.files;e.input_files=[];for(let n=0;n<t.length;n++){const i=t[n],s=ae(i.name);ge[s]={name:s,size:i.size,type:i.type,"file-obj":i};let o=document.createElement("input-file");o.setAttribute("name",s),o.setAttribute("size",i.size),o.setAttribute("type",i.type),o.remove_file=function(){e.input_files=e.input_files.filter((e=>!(e.getAttribute("name")==o.getAttribute("name")))),o.querySelector(".file").setAttribute("style","animation: file_anim_remove 0.7s forwards;"),setTimeout((function(){o.remove(),0==e.input_files.length&&(document.querySelector(".uploaded-files").setAttribute("class","uploaded-files"),e.render())}),600)},e.input_files.push(o)}e.render(),le()}))}connectedCallback(){document.querySelector("#add-files").onclick=()=>{this.file_upload_elem.click()},document.querySelector(".upload-info-block").onclick=()=>{this.file_upload_elem.click()}}render(){const e=document.querySelector(".uploaded-files");let t=e.children;const n=t.length;let i=0;for(let e=0;e<n;e++)"upload-info-block"!=t[i].getAttribute("class")?t[i].remove():i+=1;if(0==this.input_files.length)e.setAttribute("style","width: calc(100% - 30px); height: calc(100% - 30%);"),e.setAttribute("class","uploaded-files");else{e.setAttribute("style",""),e.setAttribute("class","uploaded-files files-availabe");for(let t=0;t<this.input_files.length;t++)e.append(this.input_files[t])}}}customElements.define("file-upload-elem",de),document.querySelector(".files-upload").append(document.createElement("file-upload-elem")),customElements.define("user-elem",oe);const ue=new EventTarget;let he,fe,pe={},me={},ge={};function _e(e,t,n){t.channel.send(JSON.stringify({type:"message",body:{type:n,id:e}}))}function be(e,t,n,i){document.addEventListener(`download-complete-${n}`,(function(){i()}));let s=me[t.connection_id][e];if(!s)return;document.worker_bridge.postMessage({type:"file-request","file-name":e,"file-type":s.type,size:s.size,"operation-id":n,"rtc-id":t.connection_id});let o=document.createElement("a");o.href=window.location.origin+"/file_id?id={}".replace("{}",n),o.target="_blank",o.click()}function ye(e){let t=e.split(".");const n=t[t.length-1];t.pop();let i=t.join("."),s=i.length;return e.length>15?i.substring(0,4)+"..."+i.substring(s-3)+"."+n:e}let we=new class{async upload_file(e,t,n,i,s,o){function a(){V.resolve(t.label,o.id),o.info_block.cancel(),o.cancel()}pe[e].event_target.addEventListener("close-channel",a);const l=function(e){const t=e.size,n=24e4;let i=0,s=new FileReader;return{read:function(){return new Promise((function(t,o){let a=e.slice(i,i+n);s.onload=function(e){let n=new Uint8Array(e.target.result);0==n.length?t({done:!0,value:null}):t({done:!1,value:n})},s.onerror=function(e){},s.readAsArrayBuffer(a),i+=n}))},cancel:function(){i=t}}}(n);W[o.id]=0;let r=document.createElement("uploadinfoblock-elem");r.setAttribute("file-name",i),r.setAttribute("conn-id",e),o.info_block=r;let c=!1;o.cancel_hook((function(){l.cancel(),c=!0})),o.channel_id=t.label;let d=0;l.read().then((async function i({done:s,value:u}){if(!s){for(let e=0;e<u.length&&!c;e+=6e4){await o.resume_promise();let i=u.subarray(e,e+6e4);d+=i.length,r.setAttribute("uploaded",Math.floor(d/n.size*100)),W[o.id]=Math.floor(d/n.size*100);let s=(new TextEncoder).encode(o.id+",");t.send(new Uint8Array([...s,...i]).buffer),o.pause=!0}return o.pause=!1,l.read().then(i)}pe[e].event_target.removeEventListener("close-channel",a);try{t.send(JSON.stringify({type:"message",body:{type:"chunk-message",chunk:u,mode:"done",id:o.id}}))}catch{}o.cancel_operation&&o.info_block.cancel()})).catch((function(e){console.log(e)}))}},ve={};navigator.serviceWorker.register("/static/sw.js",{scope:"/"}).then((function(e){navigator.serviceWorker.addEventListener("message",(function(e){let t=e.data;"connection-complete"==t.type?(ve[t["operation-id"]]={size:me[t["rtc-id"]][t["file-name"]].size,downloaded:0},pe[t["rtc-id"]].channel.send(JSON.stringify({type:"message",body:{type:"request-to-download","file-name":t["file-name"],"operation-id":t["operation-id"],"start-index":0}}))):"resume"==t.type?_e(t["operation-id"],pe[t["rtc-id"]],"resume"):"download-complete"==t.type&&(delete ve[t["operation-id"]],document.dispatchEvent(new Event(`download-complete-${t["operation-id"]}`)))})),document.worker_bridge=e.active;const n=window.location.href.replace(window.location.origin+window.location.pathname,"").split("?");if(n)try{fe=n[1].split("=")[1]}catch{}let i="ws";"https:"==window.location.protocol&&(i="wss");const s=new WebSocket(i+":"+window.location.hostname+":"+window.location.port+"/");function o(e,t){if("request-to-download"==t.type)ge[t["file-name"]]&&we.upload_file(e.connection_id,e.channel,ge[t["file-name"]]["file-obj"],t["file-name"],t["start-index"],new J(ue,t["operation-id"]));else if("user-info"==t.type)se(e.connection_id,t.color,t.image);else if(-1!=["pause","main-pause","resume","main-resume","cancel"].indexOf(t.type))ue.dispatchEvent(new CustomEvent(t.id,{detail:{type:t.type}}));else if("files-data"==t.type)e.user_obj.addFiles(t.files),me[e.connection_id]=t.files;else if("chunk-message"==t.type){"done"!=t.mode&&(ve[t.id].downloaded+=t.chunk.length);const e=Math.round(ve[t.id].downloaded/ve[t.id].size*100);let n=Array.from(document.querySelectorAll("download-elem")).find((n=>n.getAttribute("operation_id")==t.id&&(n.setAttribute("downloaded",e),!0)));"done"==t.mode&&(100==e?n.success():n.error()),document.worker_bridge.postMessage({type:"file-data",chunk:t.chunk,"operation-id":t.id,done:"done"==t.mode})}else if("get-info-about-files"==t.type){let e=0;for(let t in ge)e+=1;if(0==e)return;for(let e in pe)pe[e].channel.send(JSON.stringify({type:"message",body:{type:"files-data",files:ge}}))}else if("map"==t.type){if(t.map[t.map.length-1]!=he){let e=-1;if(t.map.find(((t,n)=>(e=n,t==he))),-1==e)return;return void pe[t.map[e+1]].channel.send(JSON.stringify({type:"message",body:t}))}a(t.body,{send:function(e){let n=t.map.reverse();pe[n[1]].channel.send(JSON.stringify({type:"message",body:{type:"map",map:n,body:JSON.parse(e)}}))}})}}async function a(e,n){if("offer"==e.type){const i=new t;i.addEventListener("open-channel",(function(){i.user_obj=document.createElement("user-elem"),i.user_obj.setAttribute("conn-id",e["sender-id"]),document.querySelector(".users-files").append(i.user_obj);let t=g.nodes.find((e=>"self"==e.conn_id));i.channel.send(JSON.stringify({type:"message",body:{type:"user-info",color:t.color,image:t.image}})),i.addEventListener("message",(function(e){let t;try{t=JSON.parse(e.detail.data)}catch{let n=new Uint8Array(e.detail.data);const i=n.indexOf(44);if(-1==i)return;const s=(new TextDecoder).decode(n.slice(0,i));if(!ve[s])return;t={type:"message",body:{type:"chunk-message",chunk:n.slice(i+1),id:s,mode:"load"}}}"message"!=t.type?a(t,i.channel):o(i,t.body)}))})),i.addEventListener("close-channel",(function(){ie(e["sender-id"]),delete pe[e["sender-id"]],delete me[e["sender-id"]],i.user_obj.remove(),document.worker_bridge.postMessage({type:"close-channel","conn-id":e["sender-id"]})}));const s=await i.createAnswer(e.offer);pe[e["sender-id"]]=i,pe[e["sender-id"]].connection_id=e["sender-id"],n.send(JSON.stringify({type:"answer",answer:s,"sender-id":he,"receiver-id":e["sender-id"]}))}else if("answer"==e.type){const t=pe[e["sender-id"]];if(!t)return;t.connection_id=e["sender-id"],t.accept(e.answer)}else if("create-connect"==e.type){const i=new t;let s=e["sender-id"];i.addEventListener("open-channel",(function(){i.user_obj=document.createElement("user-elem"),i.user_obj.setAttribute("conn-id",s),document.querySelector(".users-files").append(i.user_obj);let e=g.nodes.find((e=>"self"==e.conn_id));i.channel.send(JSON.stringify({type:"message",body:{type:"user-info",color:e.color,image:e.image}})),i.addEventListener("message",(function(e){let t;try{t=JSON.parse(e.detail.data)}catch{let n=new Uint8Array(e.detail.data);const i=n.indexOf(44);if(-1==i)return;const s=(new TextDecoder).decode(n.slice(0,i));if(!ve[s])return;t={type:"message",body:{type:"chunk-message",chunk:n.slice(i+1),id:s,mode:"load"}}}"message"!=t.type?a(t,i.channel):o(i,t.body)})),i.channel.send(JSON.stringify({type:"message",body:{type:"get-info-about-files"}}))})),i.addEventListener("close-channel",(function(){ie(s),delete pe[s],delete me[s],i.user_obj.remove(),document.worker_bridge.postMessage({type:"close-channel","conn-id":s})}));const l=await i.createOffer(s);pe[s]=i,pe[s].connection_id=s,n.send(JSON.stringify({type:"offer",offer:l,"sender-id":he,"receiver-id":s}))}else if("find-nodes"==e.type)for(let t in pe){if(pe[t].connection_id==e["sender-id"])continue;let n=[e["sender-id"],he,pe[t].connection_id];pe[t].channel.send(JSON.stringify({type:"message",body:{type:"map",map:n,body:{type:"create-connect","sender-id":e["sender-id"],"receiver-id":n[2]}}}))}}s.onclose=function(e){console.log(e)},s.onerror=function(e){console.log(e)},s.onmessage=async function(e){let n=e.data;try{n=JSON.parse(n)}catch{}if("connection-error"==n.type)window.location.href=window.location.origin+window.location.pathname;else if("client-id"==n.type&&null==n["receiver-id"]){he=n.id;let e=Math.floor(65535*Math.random()),i=new Uint8Array(4);i[0]=255&e,i[1]=(65280&e)>>8,i[2]=(16711680&e)>>16,i[3]=255;let l=k[Math.floor(Math.random()*k.length)];if(await se("self",i,l),document.dispatchEvent(new Event("program-ready")),fe){document.querySelector("#link").innerText=window.location.href;const e=new t;e.addEventListener("open-channel",(function(){s.close(),e.user_obj=document.createElement("user-elem"),e.user_obj.setAttribute("conn-id",fe),document.querySelector(".users-files").append(e.user_obj);let t=g.nodes.find((e=>"self"==e.conn_id));e.channel.send(JSON.stringify({type:"message",body:{type:"user-info",color:t.color,image:t.image}})),e.channel.send(JSON.stringify({type:"find-nodes","sender-id":he})),e.addEventListener("message",(function(t){let n;try{n=JSON.parse(t.detail.data)}catch{let e=new Uint8Array(t.detail.data);const i=e.indexOf(44);if(-1==i)return;const s=(new TextDecoder).decode(e.slice(0,i));if(!ve[s])return;n={type:"message",body:{type:"chunk-message",chunk:e.slice(i+1),id:s,mode:"load"}}}"message"!=n.type?a(n,e.channel):o(e,n.body)})),e.channel.send(JSON.stringify({type:"message",body:{type:"get-info-about-files"}}))})),e.addEventListener("close-channel",(function(){ie(fe),delete pe[fe],delete me[fe],e.user_obj.remove(),document.worker_bridge.postMessage({type:"close-channel","conn-id":fe})}));const n=await e.createOffer(fe);pe[fe]=e,pe[fe].connection_id=fe,s.send(JSON.stringify({type:"offer",offer:n,"sender-id":he,"receiver-id":fe}))}else document.querySelector("#link").innerText=window.location.origin+"?id="+he;return}a(n,s)}})).catch((function(e){console.log(e)}))})();